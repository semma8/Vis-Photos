{%- assign fields = site.data.config-metadata -%}
{%- assign stubs = site.data.config-nav | map: 'stub' | join: ';' -%}
{%- assign items = site.data[site.metadata] | where_exp: 'item', 'item.objectid != nil' -%}
<script>
(function(){
    /* add item data */
    var items = { 
        {%- for item in items -%}
        {{ item.objectid | jsonify }} : { {% unless fields contains 'title' %}"title": {{ item.title | jsonify }}, {% endunless %}{% for f in fields %}{% if item[f.field] %}{{ f.field | jsonify }}: {{ item[f.field] | jsonify }}, {% endif %}{% endfor %}{% if item.youtubeid %} "youtube": {{ item.youtubeid | jsonify }}, {% endif %}{% if item.vimeoid %} "vimeo": {{ item.vimeoid | jsonify }}, {% endif %}"format": {{ item.format | jsonify }}, {% if  item.filename contains '/' %}"filename": "{{ item.filename }}" {% else %}"filename":{{ '/objects/' | relative_url | append: item.filename | jsonify }}{% endif %} }{% unless forloop.last %}, {% endunless %}
        {% endfor %}
    };
    var children = { {%- assign parents = site.data[site.metadata] | map: 'parentid' | compact | uniq -%}{%- for p in parents -%}
        {{ p | jsonify }}: [
        {%- assign children = site.data[site.metadata] | where: 'parentid', p -%}
        {%- for c in children -%}
        { {% if c.title %}"title": {{ c.title | jsonify }}, {% endif %}"filename": {{ c.filename | jsonify }}, {% if c.youtubeid %}"youtube": {{ c.youtubeid | jsonify }}, {% endif %}{% if c.vimeoid %} "vimeo": {{ c.vimeoid }}, {% endif %}"format": {{ c.format | jsonify }} }
        {%- unless forloop.last -%}, {%- endunless -%}{%- endfor -%}]{%- unless forloop.last -%}, {%- endunless -%}{%- endfor -%}
    };

    /* get query id from URL */
    var queryString = window.location.search.substring(1).split("=")[1];
    var record = items[queryString];
    var compoundObject = children[queryString];

    if (record) {
        /* add item title */
        var objectTitle = record.title;
        document.getElementById("bc-title").innerHTML = objectTitle;
        document.getElementById("item-title").innerHTML = objectTitle;
        /* add object */ 
        var format = "" + record.format;
        var objectLink = record.filename;
        var itemImage, itemLink;

        function compoundItems(firstItem) {
            var objectCount = Object.keys(compoundObject).length + 1;
            itemImage= '<p>View ' + objectCount + ' Items Below<br></p>' + firstItem;
            itemLink= '<div class="dropdown d-inline"><button class="btn btn-dark dropdown-toggle" type="button" title="Object download" id="compoundButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Download Items</button> <div class="dropdown-menu" aria-labelledby="compoundButton">';
            itemLink += '<a class="dropdown-item" target="_blank" href="' + objectLink + '">Part 1 of ' + objectTitle + '</a>';
            for (let i = 0; i < compoundObject.length; i++) {
                var compoundLink = compoundObject[i].filename;
                var compoundFormat = compoundObject[i].format;
                var compoundTitle = compoundObject[i].title;
                var partOrder = i + 2;
                if (compoundFormat.includes('image')) {
                    itemImage += '<div class="spotlight gallery-img mt-4" data-src="' + compoundLink + '"><img class="img-fluid" src="' + compoundLink + '" alt="part ' + partOrder + ' of ' + objectTitle + '">'
                } else if (compoundFormat.includes('pdf')) {
                    itemImage += '<object aria-label="' + compoundTitle + '" data="' + compoundLink + '" type="application/pdf" width="100%" height="450px" class="mt-4"><p>The PDF is not rendering in your browser. Please use the button below to download the PDF.</p></object>';
                } else if (compoundFormat.includes('audio')) {
                    itemImage += '<audio controls class="w-100 mt-4"><source src="' + compoundLink + '">Your browser does not support the audio element.</audio>';
                } else if (compoundObject[i].youtube) {
                    itemImage += '<div class="ratio ratio-16x9 mt-4"><iframe title="part ' + partOrder + ' of ' + objectTitle + '" src="https://www.youtube-nocookie.com/embed/' + compoundObject[i].youtube + '?rel=0&modestbranding=1" allowfullscreen></iframe></div>';
                    compoundLink = 'https://youtu.be/' + compoundObject[i].youtube;
                } else if (compoundObject[i].vimeo) {
                    itemImage += '<div class="ratio ratio-16x9 mt-4"><iframe title="part ' + partOrder + ' of ' + objectTitle + '"src="https://player.vimeo.com/video/' + compoundObject[i].vimeo + '" allowfullscreen></iframe></div>';
                    compoundLink = 'https://vimeo.com/' + compoundObject[i].vimeo;
                } else if (compoundFormat.includes('video')) {
                    itemImage += '<video controls class="w-100 mt-4"><source src="' + objectLink + '">Your browser does not support the video element.</audio>';
                } else {
                    /* fall back to no preview if it doesn't know the format */
                    itemImage += '<img class="w-50" src="{{ "/assets/lib/icons/file-earmark.svg" | relative_url }}" alt="No preview found">';
                }
                compoundTitle ? itemImage += '<p class="pt-2">' + compoundTitle + '<hr></p></div>' : itemImage += '</div>'
                // add download dropdown
                itemLink += '<a class="dropdown-item" target="_blank" rel="noopener" href="' + compoundLink + '">Part ' + partOrder + ' of ' + objectTitle + '</a>';
            }
            itemLink += '</div></div>';
        };

        if (format.includes('image')) {
            if (compoundObject) {
                var firstItem = '<div class="spotlight gallery-img" data-download="true" data-src="' + objectLink + '"><img class="img-fluid" src="' + objectLink + '" alt="' + objectTitle + '"></div>';
                compoundItems(firstItem);
            } else {
                itemImage= '<div class="spotlight gallery-img" data-download="true" data-src="' + objectLink + '"><img class="img-fluid" src="' + objectLink + '" alt="' + objectTitle + '"><p><small>Click to view full screen</small></p></div>';
                itemLink= '<a href="' + objectLink + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download Image</a>';
            }
        } else if (format.includes('pdf')) {
            itemImage= '<object aria-label="' + objectTitle + '" data="' + objectLink + '" type="application/pdf" width="100%" height="450px"><p>The PDF is not rendering in your browser. Please use the button below to download the PDF.</p></object>';
            compoundObject ? compoundItems(itemImage) : itemLink= '<a href="' + objectLink + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download PDF</a>';
        } else if (format.includes('audio')) {
            itemImage= '<audio controls class="w-100"><source src="' + objectLink + '">Your browser does not support the audio element.</audio>';
            compoundObject ? compoundItems(itemImage) : itemLink= '<a href="' + objectLink + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download Audio File</a>';
        } else if (record.youtube) {
            itemImage= '<div class="ratio ratio-16x9"><iframe title="' + objectTitle + '" src="https://www.youtube-nocookie.com/embed/' + record.youtube + '?rel=0&modestbranding=1" allowfullscreen></iframe></div>';
            compoundObject ? compoundItems(itemImage) : itemLink= '<a href="https://youtu.be/' + record.youtube + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">View on YouTube</a>';
        } else if (record.vimeo) {
            itemImage= '<div class="ratio ratio-16x9"><iframe title="' + objectTitle + '"src="https://player.vimeo.com/video/' + record.vimeo + '" allowfullscreen></iframe></div>';
            compoundObject ? compoundItems(itemImage) : itemLink= '<a href="https://vimeo.com/' + record.vimeo + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">View on Vimeo</a>';
        } else if (format.includes('video')) {
            itemImage= '<video controls class="w-100"><source src="' + objectLink + '">Your browser does not support the video element.</audio>';
            compoundObject ? compoundItems(itemImage) : itemLink= '<a href="' + objectLink + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download Video File</a>';
        } else {
            /* fall back to no preview if it doesn't know the format */
            itemImage= '<img class="w-50" src="{{ "/assets/lib/icons/file-earmark.svg" | relative_url }}" alt="No preview found">';
            compoundObject ? compoundItems(itemImage) : itemLink= '<a href="' + objectLink + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download Object</a>';
        }

        {% if stubs contains "timeline" %}
        /* add link to view on timeline */
        if (record.date) {
            var itemYear;
            if (record.date.includes('-')) {
                itemYear = record.date.split('-')[0];
            } else if (record.date.includes('/')) {
                itemYear = record.date.split('/').pop();
            } else {
                itemYear = record.date;
            }
            itemLink += '<a href="{{ "/timeline.html" | relative_url }}#y' + itemYear + '" class="m-2 btn btn-outline-dark">View on Timeline</a>';
        }
        {%- endif -%}
        {% if stubs contains "map" %}
        /* add link to view on map */ 
        if (record.latitude && record.longitude) {
            itemLink += '<a href="{{ '/map.html' | relative_url }}#' + record.latitude + ',' + record.longitude + '" class="m-2 btn btn-outline-dark">View on Map</a>';
        }
        {%- endif -%}

        /* add content to item display area */
        document.getElementById("item-image").innerHTML = itemImage;
        document.getElementById("item-link").innerHTML = itemLink;
        
        /* trigger Gallery for images */
        // ?

        /* add item metadata */
        var fields = '<dl>';
        {% for f in fields %}{% if f.browse_link == "true" %}
        if (record[{{ f.field | jsonify }}]) {
            var topics = record[{{ f.field | jsonify }}].split(';');
            var browseLinks = "";
            for (var i = 0, len = topics.length; i < len; i++) {
                if (topics[i] != "") {
                    browseLinks += '<a class="btn btn-link" href="{{ '/browse.html' | relative_url }}#' + encodeURIComponent(topics[i].trim()) + '">' + topics[i].trim() + '</a> ';
                }
            }
            fields += '<dt class="field">{{ f.display_name }}:</dt> <dd class="field-value">' + browseLinks + '</dd>';
        }
        {%- else -%}
        if (record[{{ f.field | jsonify }}]) { fields += '<dt class="field">{{ f.display_name }}:</dt> <dd class="field-value">{% if f.external_link == "true" %}<a href="' + record[{{ f.field | jsonify }}] + '" target="_blank" rel="noopener">' + record[{{ f.field | jsonify }}] + '</a>{% else %}' + record[{{ f.field | jsonify }}] + '{% endif %}</dd>'; }
        {% endif %}{% endfor %}
        fields += '</dl>';
        document.getElementById("item-metadata").innerHTML = fields;

        {% if site.data.theme.browse-buttons == true %}
        /* add prev/next nav */
        var itemKeys = Object.keys(items);
        var current = itemKeys.indexOf(queryString);
        var last = itemKeys.length - 1;
        var back, forward;
        if (current === 0) {
            back = itemKeys[last];
        } else { 
            back = itemKeys[current - 1];
        }
        if (current === last) {
            forward = itemKeys[0];
        } else {
            forward = itemKeys[current + 1];
        }
        var backUrl = "{{ '/item.html?id=' | relative_url }}" + back;
        var forwardUrl = "{{ '/item.html?id=' | relative_url }}" + forward;
        /* add side buttons to page */
        document.getElementById("back-button").href = backUrl;
        document.getElementById("next-button").href = forwardUrl;
        /* add bottom buttons to page */
        document.getElementById("prev-button").href = backUrl;
        document.getElementById("for-button").href = forwardUrl;

        /* add back forward key press */
        document.onkeydown = function(evt) {
        evt = evt || window.event;
        switch (evt.keyCode) {
            case 37:
            location.href = backUrl;
                break;
            case 39:
            location.href = forwardUrl;
                break;
        }};
        {%- endif -%}
        
    } else {
        /* no item with that ID */
        document.getElementById("bc-title").innerHTML = 'Not found?';
        document.getElementById("item-title").innerHTML = 'Sorry, item not found. Please visit <a href="{{ "/browse.html" | relative_url }}">Browse page</a> to find an item.';
    }

    /* all done, so hide loading animation */
    document.getElementById("loading").style.display = "none";

})();

</script>